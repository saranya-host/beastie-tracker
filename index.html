<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üåü Legendary Beastie Tracker 3.0</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for data visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Base CSS for Material You inspired theme and animations */
        :root {
            /* Default Dark Mode Colors (keeping these for other elements) */
            --color-primary: #8e2de2; /* Deep Purple */
            --color-secondary: #4a00e0; /* Darker Purple */
            --color-tertiary: #a8c0ff; /* Light Blue */
            --color-background: #1a1a2e; /* Dark Blue-Purple */
            --color-surface: rgba(36, 36, 58, 0.8); /* Slightly lighter surface */
            --color-text-primary: #e0e0e0; /* Light Gray */
            --color-text-secondary: #a0a0a0; /* Medium Gray */
            --color-border: rgba(255, 255, 255, 0.15);
            --color-input-bg: rgba(255, 255, 255, 0.1);
            --color-input-border: rgba(255, 255, 255, 0.3);
            --color-accent-base: #00cfff; /* Cyan for accents */
            --color-success: #8BC34A; /* Green for success */
            --color-error: #FF6F61; /* Red for error */
            
            /* RGB versions for rgba() usage */
            --color-primary-rgb: 142, 45, 226;
            --color-success-rgb: 139, 195, 74;
            --color-error-rgb: 255, 111, 97;
            --color-accent-base-rgb: 0, 207, 255;
        }

        /* Light Mode Colors - Adjusted for better contrast with image */
        body.light-mode {
            --color-primary: #673AB7; /* Deep Purple */
            --color-secondary: #512DA8; /* Darker Purple */
            --color-tertiary: #7C4DFF; /* Lighter Purple */
            --color-background: #f0f2f5; /* Light Gray Background */
            --color-surface: rgba(255, 255, 255, 0.9); /* White surface */
            --color-text-primary: #212121; /* Dark Gray */
            --color-text-secondary: #616161; /* Medium Gray */
            --color-border: rgba(0, 0, 0, 0.1);
            --color-input-bg: rgba(240, 240, 240, 0.9);
            --color-input-border: rgba(0, 0, 0, 0.2);
            --color-accent-base: #00BCD4; /* Cyan for accents */
            --color-success: #4CAF50; /* Green for success */
            --color-error: #F44336; /* Red for error */

            /* RGB versions for rgba() usage in light mode */
            --color-primary-rgb: 103, 58, 183;
            --color-success-rgb: 76, 175, 80;
            --color-error-rgb: 244, 67, 54;
            --color-accent-base-rgb: 0, 188, 212;
        }

        /* Global Reset & Core Styling */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat', sans-serif;}
        html,body {
            min-height:100vh;
            font-size: 14px;
            /* Background Image - Static */
            background-image: url('https://wallpaperaccess.com/full/39613.jpg'); /* New image URL */
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed; /* Ensures background stays fixed during scroll */
            color: var(--color-text-primary);
            display:flex;flex-direction:column;align-items:center;padding:15px;
            overflow-x: hidden;
            transition: background-color 0.5s ease, color 0.5s ease; /* Smooth theme transition */
        }
        /* No @keyframes for background animation needed */

        /* --- Material You Card Styling --- */
        .card {
            background: var(--color-surface);
            border-radius: 28px; /* More organic, rounded corners */
            width: 100%; 
            max-width: 550px; /* Slightly increased max-width */
            margin-bottom: 25px;
            padding: 32px; /* Increased padding */
            position: relative;
            overflow: hidden;
            box-shadow: 0 12px 30px rgba(0,0,0,0.3); /* Stronger, more diffused shadow */
            backdrop-filter: blur(20px) saturate(180%); /* Stronger blur for glassmorphism */
            -webkit-backdrop-filter: blur(20px) saturate(180%);

            transform:translateY(30px);
            opacity:0;
            animation:fadeInUp .9s ease forwards;
        }
        @keyframes fadeInUp{to{transform:translateY(0);opacity:1}}

        /* --- Headings & Text --- */
        h1{
            font-family: 'Orbitron', sans-serif;
            font-size:3.2rem;
            margin-bottom:15px;
            color: #ffffff; /* Explicitly white for contrast */
            text-shadow: 0 0 15px rgba(0, 200, 255, 0.6); /* Subtle glow */
            letter-spacing: 2px;
            text-align: center;
            line-height: 1.2;
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }
        #greeting{font-size:1.1rem;margin-bottom:15px;opacity:.9; color: #ffffff; text-align: center;}
        .quote{font-size:1.2rem;font-style:italic;opacity:.8;margin-bottom:25px;color: #ffffff; text-align: center; line-height: 1.5;}

        /* --- Inputs, Selects, Textareas --- */
        input,select,textarea{
            width:100%;padding:14px;margin-bottom:18px;
            background:var(--color-input-bg);
            color:var(--color-text-primary);
            border:1px solid var(--color-input-border);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 16px; /* Material You rounded inputs */
            transition: all .3s ease;
        }
        input::placeholder, textarea::placeholder {color: var(--color-text-secondary);}
        select option {background: var(--color-surface); color: var(--color-text-primary);}

        input:focus,select:focus,textarea:focus{
            background:rgba(255,255,255,0.2); /* Slightly brighter on focus */
            box-shadow:0 0 0 3px var(--color-accent-base), 0 0 15px var(--color-accent-base); /* Accent glow */
            outline:none;
            transform: scale(1.005);
        }

        /* --- Buttons (Material You Inspired) --- */
        button{
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            color:#fff;
            padding:12px 24px;
            font-weight:700;
            cursor:pointer;
            border-radius:28px; /* Organic button shape */
            border:none; /* No hard border */
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
            position: relative;
            z-index: 0;
            overflow: hidden;
            transition:all .3s ease;
            font-size: 1rem;
        }
        button:hover{
            background: linear-gradient(90deg, var(--color-secondary), var(--color-primary)); /* Reverse gradient on hover */
            box-shadow:0 0 20px rgba(138,43,226,0.6); /* Softer glow */
            transform:scale(1.02);
        }
        button:active{transform:scale(0.98);box-shadow:0 3px 10px rgba(0,0,0,0.4);}
        .clear-btn{
            background:linear-gradient(90deg, var(--color-error), #DE4B70);
            color:#fff;
        }
        .clear-btn:hover{
            background:linear-gradient(90deg, #DE4B70, var(--color-error));
            box-shadow:0 0 20px rgba(255,111,97,0.6);
        }

        /* --- Radio Group & Calendar --- */
        .radio-group{display:flex;gap:15px;margin-bottom:20px;flex-wrap: wrap; justify-content: center;}
        .radio-group label {
            background: var(--color-input-bg);
            padding: 10px 18px;
            border-radius: 20px; /* More rounded radio buttons */
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--color-input-border);
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text-primary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .radio-group input[type="radio"] {display: none;}
        .radio-group input[type="radio"] + label::before {
            content: '';
            display: inline-block;
            width: 18px; height: 18px;
            border-radius: 50%;
            border: 2px solid var(--color-accent-base); /* Accent color border */
            background-color: transparent;
            margin-right: 5px;
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .radio-group input[type="radio"]:checked + label {
            background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); /* Vibrant gradient on selection */
            border-color: var(--color-accent-base);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
            color: #fff; /* White text when selected */
        }
        .radio-group input[type="radio"]:checked + label::before {
            background-color: #fff;
            border-color: #fff;
            box-shadow: 0 0 8px rgba(255,255,255,0.7);
        }
        
        .stats, .goals { margin-bottom:20px; color:var(--color-text-primary); font-size:1.1rem; line-height: 1.7;}
        .calendar{
            display:flex;gap:12px;
            overflow-x:auto;
            margin-bottom:25px;padding-bottom:8px;
            padding: 6px;
            border-radius: 20px; /* More rounded calendar container */
            background: var(--color-input-bg);
            border: 1px solid var(--color-input-border);
            box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
        }
        .calendar div{
            padding:10px 18px;border-radius:16px; /* Rounded calendar days */
            background:rgba(255,255,255,0.1);color:var(--color-text-primary);
            cursor:pointer;transition:all .3s ease;
            border:1px solid rgba(255,255,255,0.2);
            min-width: 65px; /* Slightly larger days */
            text-align: center;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .calendar div:hover{
            background:rgba(255,255,255,0.2); 
            transform: translateY(-3px) scale(1.03); /* Softer lift */
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        .calendar .today{
            border:2px solid var(--color-accent-base); /* Accent color highlight for today */
            box-shadow:0 0 12px rgba(var(--color-accent-base-rgb), 0.7), inset 0 0 6px rgba(var(--color-accent-base-rgb), 0.4);
            background: linear-gradient(45deg, var(--color-accent-base), #61DAFB);
            color: var(--color-background); /* Darker text for contrast on bright today */
            font-weight: 700;
        }
        .calendar .has-study {
            background-color: rgba(var(--color-primary-rgb), 0.2); /* Subtle highlight for study days */
            border-color: var(--color-primary);
        }
        .calendar .goal-achieved {
            background: linear-gradient(45deg, var(--color-success), #AED581); /* Green gradient for goal achieved */
            border-color: var(--color-success);
            color: #333;
        }


        #clock{
            position:fixed;top:20px;right:20px;padding:10px 18px;background:var(--color-surface);color:var(--color-text-primary);border-radius:24px;
            font-family: 'Orbitron', sans-serif; font-size:1rem; letter-spacing: 1px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            animation: pulseClock 2s infinite alternate;
            z-index: 10; /* Ensure clock stays on top */
        }
        @keyframes pulseClock {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.02); opacity: 0.9; }
        }

        /* Goal Progress Bar */
        #goalProgress {height:12px;border-radius:6px;background:var(--color-input-bg);overflow:hidden;margin:12px 0; border: 1px solid var(--color-input-border);}
        #goalFill{height:100%;width:0%;background:linear-gradient(90deg,var(--color-primary),var(--color-secondary));transition:width .9s cubic-bezier(0.68, -0.55, 0.265, 1.55);}
        #goalFill.complete {
            background: linear-gradient(90deg, var(--color-success), #6AC433);
            animation: goalComplete 1.5s ease-out forwards;
            box-shadow: 0 0 20px rgba(var(--color-success-rgb), 0.7);
        }
        @keyframes goalComplete {
            0% { transform: scaleX(0.9); opacity: 0.8; }
            50% { transform: scaleX(1.05); opacity: 1; box-shadow: 0 0 25px var(--color-primary); }
            100% { transform: scaleX(1); opacity: 1; }
        }

        /* Streak Display */
        #streakDisplay {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            margin-bottom: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px;
            background: var(--color-input-bg);
            border-radius: 20px;
            border: 1px solid var(--color-input-border);
            box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
        }
        .streak-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.2); /* Inactive - lighter */
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.4s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .streak-dot.active {
            background: radial-gradient(circle at 30% 30%, var(--color-accent-base), #00cfff);
            border-color: var(--color-accent-base);
            box-shadow: 0 0 15px rgba(var(--color-accent-base-rgb), 0.7), 0 0 25px rgba(var(--color-accent-base-rgb), 0.5);
            animation: streakGlow 2s infinite alternate;
        }
        @keyframes streakGlow {
            from { box-shadow: 0 0 15px rgba(var(--color-accent-base-rgb), 0.7); }
            to { box-shadow: 0 0 20px rgba(var(--color-accent-base-rgb), 0.7), 0 0 35px rgba(var(--color-accent-base-rgb), 0.4); }
        }

        /* --- AUTH POPUP --- */
        #authOverlay {
            position:fixed;inset:0;
            backdrop-filter:blur(18px) saturate(180%);
            background:rgba(0,0,0,0.8);
            align-items:center;justify-content:center;
            z-index:9999;
            opacity: 0; /* Managed by JS */
            visibility: hidden; /* Managed by JS */
            transition: opacity 0.5s ease, visibility 0.5s ease, transform 0.5s ease;
        }
        #authOverlay.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        #authPopup {
            background:var(--color-surface);
            backdrop-filter:blur(25px) saturate(200%);
            -webkit-backdrop-filter:blur(25px) saturate(200%);
            padding:35px;border-radius:28px;max-width:450px;width:90%;
            box-shadow:0 20px 60px rgba(0,0,0,0.4);
            text-align:center;color:var(--color-text-primary);
            animation:slideUp .9s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border:1px solid var(--color-border);
            position: relative;
            overflow: hidden;
        }
        #authPopup h2 {font-family: 'Orbitron', sans-serif; margin-bottom: 20px; font-size: 2rem; color: var(--color-accent-base);}
        #authPopup input {
            padding:14px;width:100%;margin-bottom:25px;
            background:var(--color-input-bg);color:var(--color-text-primary);
            border:1px solid var(--color-input-border);
            border-radius:16px;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.1);
        }
        #authPopup input:focus{box-shadow:0 0 0 3px var(--color-accent-base),0 0 20px rgba(var(--color-accent-base-rgb), 0.7);}
        #authPopup button{
            padding:14px 30px;
            background:linear-gradient(45deg, var(--color-accent-base), #4D8EFF); 
            color:#fff;
            border:none;
            border-radius:28px;
            cursor:pointer;
            font-weight:700;
            transition:all .5s ease; 
            box-shadow:0 8px 20px rgba(0,196,204,0.4);
            position: relative;
            overflow: hidden;
            /* Fix for stretched button */
            display: block; /* Make it a block element to center with margin auto */
            margin: 0 auto; /* Center the button */
            max-width: 250px; /* Limit its width */
        }
        #authPopup button:hover{
            background:linear-gradient(45deg, #4D8EFF, var(--color-accent-base)); transform: translateY(-3px); box-shadow:0 12px 25px rgba(0,196,204,0.5);
        }

        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{transform:translateY(100px);opacity:0}to{transform:translateY(0);opacity:1}}
        @keyframes fadeOut{to{opacity:0; transform: translateY(-40px);}}

        /* --- Custom Message Box --- */
        #messageBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-surface);
            color: var(--color-text-primary);
            padding: 15px 25px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #messageBox.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-10px);
        }
        #messageBox.error { background: var(--color-error); color: #fff; }
        #messageBox.success { background: var(--color-success); color: #fff; }

        /* --- Confirmation Modal (for Clear All Logs) --- */
        #confirmModalOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #confirmModalOverlay.show {
            opacity: 1;
            visibility: visible;
        }
        #confirmModal {
            background: var(--color-surface);
            padding: 30px;
            border-radius: 28px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: var(--color-text-primary);
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border: 1px solid var(--color-border);
        }
        #confirmModalOverlay.show #confirmModal {
            transform: translateY(0);
            opacity: 1;
        }
        #confirmModal h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--color-text-primary);
        }
        #confirmModal .button-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        #confirmModal button {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* --- Accent Color Picker --- */
        #accentColorPicker {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .color-swatch {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .color-swatch.selected {
            border-color: var(--color-text-primary); /* Highlight selected swatch */
            box-shadow: 0 0 0 3px var(--color-accent-base), 0 0 10px rgba(var(--color-accent-base-rgb), 0.7);
        }

        /* --- Pomodoro Timer --- */
        #pomodoroTimer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #timerDisplay {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            color: var(--color-accent-base);
            text-shadow: 0 0 10px rgba(var(--color-accent-base-rgb), 0.5);
            margin-bottom: 10px;
        }
        #timerControls {
            display: flex;
            gap: 15px;
        }
        #timerControls button {
            padding: 10px 20px;
            font-size: 0.9rem;
            border-radius: 20px;
        }
        #pomodoroSettings {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
            color: var(--color-text-secondary);
        }
        #pomodoroSettings input {
            width: 80px;
            margin-bottom: 0;
            padding: 8px;
            font-size: 0.9rem;
            text-align: center;
        }

        /* --- To-Do List --- */
        #todoListContainer {
            margin-top: 20px;
        }
        #todoInput {
            margin-bottom: 10px;
        }
        .todo-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--color-input-bg);
            padding: 10px 15px;
            border-radius: 16px;
            margin-bottom: 8px;
            border: 1px solid var(--color-input-border);
            transition: all 0.3s ease;
        }
        .todo-item.completed {
            opacity: 0.7;
            text-decoration: line-through;
            background: rgba(var(--color-success-rgb), 0.1);
        }
        .todo-item span {
            flex-grow: 1;
            color: var(--color-text-primary);
        }
        .todo-item button {
            background: none;
            border: none;
            color: var(--color-error);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
            box-shadow: none;
        }
        .todo-item button:hover {
            color: #fff;
            background: var(--color-error);
            transform: scale(1.1);
        }
        .todo-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: var(--color-primary); /* Material You checkbox color */
        }

        /* --- Data Visualizations --- */
        #chartsContainer {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-wrapper {
            background: var(--color-input-bg);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid var(--color-input-border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            /* Responsive height for charts */
            height: 350px; /* Default height for larger screens */
            overflow-y: hidden; /* Hide scrollbar on larger screens */
        }
        .chart-wrapper h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
            color: var(--color-accent-base);
        }
        canvas {
            max-width: 100%;
            height: auto; /* Allow canvas to scale within its wrapper */
        }

        /* --- Gamification --- */
        #gamificationSection {
            text-align: center;
            margin-top: 20px;
        }
        #levelDisplay {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: var(--color-primary);
            margin-bottom: 10px;
        }
        #xpProgress {
            height: 10px;
            background: var(--color-input-bg);
            border-radius: 5px;
            overflow: hidden;
            margin: 0 auto 15px;
            max-width: 80%;
            border: 1px solid var(--color-input-border);
        }
        #xpFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--color-accent-base), var(--color-tertiary));
            transition: width 0.5s ease-out;
        }
        #xpText {
            color: var(--color-text-secondary);
        }
        #achievementsGrid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .achievement-badge {
            background: var(--color-input-bg);
            padding: 15px;
            border-radius: 20px;
            text-align: center;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-input-border);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        .achievement-badge.earned {
            opacity: 1;
            background: linear-gradient(135deg, var(--color-success), #AED581);
            color: #333;
            box-shadow: 0 5px 15px rgba(var(--color-success-rgb), 0.5);
            transform: scale(1.05);
        }
        .achievement-badge.earned:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(var(--color-success-rgb), 0.7);
        }
        .achievement-badge .icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }
        .achievement-badge .name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* --- Filtering & Search --- */
        #filterSearchContainer {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        #filterSearchContainer input, #filterSearchContainer select {
            margin-bottom: 0; /* Override default input margin */
        }
        #logListContainer {
            margin-top: 20px;
            max-height: 400px; /* Scrollable log list */
            overflow-y: auto;
            padding-right: 10px; /* Space for scrollbar */
        }
        .log-entry {
            background: var(--color-input-bg);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid var(--color-input-border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: var(--color-text-primary);
            line-height: 1.5;
            transition: all 0.3s ease;
        }
        .log-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .log-entry strong { color: var(--color-accent-base); }
        .log-entry em { color: var(--color-text-secondary); }

        /* General utility classes for flexbox within cards */
        .flex-col-gap-md {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .flex-row-gap-md {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        /* --- Spinner CSS --- */
        .spinner {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #4285f4, /* Blue */
                #ea4335, /* Red */
                #fbbc05, /* Yellow */
                #34a853, /* Green */
                #4285f4  /* Blue (to complete the cycle) */
            );
            animation: rotate 1s linear infinite;
            mask: radial-gradient(farthest-side, transparent 60%, black 61%);
            -webkit-mask: radial-gradient(farthest-side, transparent 60%, black 61%);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05) inset,
                        0 0 20px rgba(0, 0, 0, 0.1);
        }

        @keyframes rotate {
            100% {
                transform: rotate(360deg);
            }
        }

        /* --- Loading Overlay --- */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8); /* Darker background for contrast */
            backdrop-filter: blur(15px) saturate(180%); /* Glassmorphism effect */
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            display: flex;
            flex-direction: column; /* Stack spinner and text vertically */
            justify-content: center;
            align-items: center;
            z-index: 10002; /* Higher than authOverlay */
            opacity: 1; /* Initially visible */
            visibility: visible;
            transition: opacity 0.5s ease, visibility 0.5s ease; /* Smooth fade-out */
        }

        #loadingOverlay .loading-message {
            margin-top: 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #ffffff; /* White text for visibility */
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            text-align: center;
            padding: 0 20px; /* Add some padding for small screens */
        }

        /* --- Tab Navigation --- */
        #tabNav {
            display: flex;
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
            justify-content: center;
            gap: 10px; /* Space between tabs */
            margin-bottom: 25px;
            padding: 10px;
            background: var(--color-surface);
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid var(--color-border);
        }

        .tab-button {
            background: var(--color-input-bg);
            color: var(--color-text-primary);
            padding: 10px 18px;
            border-radius: 20px;
            border: 1px solid var(--color-input-border);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap; /* Prevent text wrapping inside buttons */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tab-button.active {
            background: linear-gradient(45deg, var(--color-primary), var(--color-secondary));
            color: #fff;
            box-shadow: 0 0 15px rgba(var(--color-primary-rgb), 0.6);
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        /* --- Mobile Navigation (Hamburger) --- */
        #mobileNavToggle {
            display: none; /* Hidden by default, shown on mobile */
            font-size: 2rem;
            background: none;
            border: none;
            color: var(--color-text-primary);
            cursor: pointer;
            padding: 5px 10px;
            z-index: 1000; /* Ensure it's above other content */
        }

        #mobileNavOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #mobileNavOverlay.show {
            opacity: 1;
            visibility: visible;
        }

        #mobileNavOverlay .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2.5rem;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
        }

        #mobileNavOverlay .mobile-nav-links {
            display: flex;
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        #mobileNavOverlay .mobile-nav-links .tab-button {
            width: 200px; /* Fixed width for mobile menu buttons */
            padding: 15px 20px;
            font-size: 1.1rem;
            border-radius: 28px;
        }


        /* --- Content Sections --- */
        .content-section {
            display: none; /* Hidden by default, shown by JS */
            width: 100%;
        }
        .content-section.active {
            display: block;
        }

        /* --- Revision Hub Specific Styles --- */
        .revision-item {
            background: var(--color-input-bg);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid var(--color-input-border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: var(--color-text-primary);
            line-height: 1.5;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .revision-item.finished {
            opacity: 0.7;
            background: rgba(var(--color-success-rgb), 0.1);
            border-color: var(--color-success);
        }
        .revision-item strong { color: var(--color-accent-base); }
        .revision-item em { color: var(--color-text-secondary); }
        .revision-item .mark-button {
            align-self: flex-end; /* Align button to the right */
            padding: 8px 15px;
            font-size: 0.85rem;
            border-radius: 18px;
            background: linear-gradient(90deg, #4CAF50, #8BC34A); /* Green gradient */
            color: #fff;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .revision-item .mark-button:hover {
            background: linear-gradient(90deg, #8BC34A, #4CAF50);
            transform: scale(1.02);
        }
        .revision-item.finished .mark-button {
            background: #616161; /* Grey out when finished */
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        /* --- AI Feature Specific Styles --- */
        .ai-output-area {
            background: var(--color-input-bg);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid var(--color-input-border);
            min-height: 100px;
            margin-top: 20px;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--color-text-primary);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            overflow-y: auto; /* Allow scrolling for long content */
            max-height: 300px; /* Limit height for long content */
        }
        .ai-loading-indicator {
            text-align: center;
            font-style: italic;
            color: var(--color-text-secondary);
            margin-top: 10px;
        }

        /* --- AI Recaller Specific Styles --- */
        .recall-item {
            background: var(--color-input-bg);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid var(--color-input-border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: var(--color-text-primary);
            line-height: 1.5;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .recall-item.overdue {
            background: rgba(var(--color-error-rgb), 0.15); /* Light red for overdue */
            border-color: var(--color-error);
            box-shadow: 0 0 10px rgba(var(--color-error-rgb), 0.5);
        }
        .recall-item.completed {
            opacity: 0.7;
            background: rgba(var(--color-success-rgb), 0.1);
            border-color: var(--color-success);
        }
        .recall-item strong { color: var(--color-accent-base); }
        .recall-item em { color: var(--color-text-secondary); }
        .recall-item .mark-button {
            align-self: flex-end;
            padding: 8px 15px;
            font-size: 0.85rem;
            border-radius: 18px;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            color: #fff;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .recall-item .mark-button:hover {
            background: linear-gradient(90deg, #8BC34A, #4CAF50);
            transform: scale(1.02);
        }
        .recall-item.completed .mark-button {
            background: #616161;
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }


        /* --- MEDIA QUERIES FOR RESPONSIVENESS --- */
        @media (min-width: 1024px) {
            html, body { font-size: 15px; padding: 20px; }
            .card { max-width: 650px; padding: 40px; border-radius: 32px; }
            h1 { font-size: 4rem; letter-spacing: 3px; }
            #greeting { font-size: 1.2rem; }
            .quote { font-size: 1.3rem; }
            input, select, textarea, button { font-size: 1.1rem; padding: 16px; border-radius: 24px; }
            .radio-group label { padding: 12px 22px; border-radius: 24px; }
            .calendar div { padding: 12px 20px; border-radius: 18px; min-width: 70px; font-size: 1rem; }
            #clock { font-size: 1.2rem; top: 25px; right: 25px; padding: 12px 20px; border-radius: 28px; }
            #goalProgress { height: 14px; border-radius: 7px; }
            .streak-dot { width: 20px; height: 20px; }
            #authPopup { padding: 45px; border-radius: 32px; max-width: 500px; }
            #authPopup h2 { font-size: 2.5rem; }
            #authPopup input { padding: 16px; border-radius: 18px; }
            #authPopup button { padding: 16px 35px; border-radius: 28px; }
            #timerDisplay { font-size: 4rem; }
            #timerControls button { padding: 12px 25px; font-size: 1rem; }
            #pomodoroSettings input { width: 90px; }
            .achievement-badge { width: 130px; height: 130px; padding: 20px; border-radius: 24px; }
            .achievement-badge .icon { font-size: 3rem; }
            .achievement-badge .name { font-size: 0.95rem; }

            /* Charts on larger screens */
            .chart-wrapper {
                height: 350px; /* Default height for larger screens */
                overflow-y: hidden;
            }

            /* Desktop: Show full tab navigation, hide mobile toggle */
            #tabNav { display: flex; }
            #mobileNavToggle { display: none; }
        }

        @media (max-width: 600px) {
            html, body { padding: 10px; font-size: 13px; }
            /* Mobile-specific adjustments for cards and main content */
            .card { 
                padding: 20px; 
                margin-bottom: 18px; 
                border-radius: 20px; 
                max-width: calc(100% - 20px); /* Ensures cards don't touch edges */
            }
            #mainContent {
                padding: 0; /* Remove main content padding as cards have their own */
                max-width: 100%; /* Allow main content to use full width */
            }

            h1 { font-size: 2rem; margin-bottom: 10px; letter-spacing: 1px;}
            #greeting { font-size: 0.9rem; margin-bottom: 12px; }
            .quote { font-size: 0.95rem; margin-bottom: 18px;}
            #clock { font-size: 0.85rem; right: 10px; top: 10px; padding: 7px 12px; border-radius: 18px; }
            
            input, select, textarea, button { padding: 10px; margin-bottom: 12px; font-size: 0.9rem; border-radius: 16px; }
            .radio-group { flex-direction: column; gap: 8px; align-items: stretch;}
            .radio-group label { padding: 8px 12px; border-radius: 16px; justify-content: center; }
            .button-row { flex-direction: column; gap: 10px; }
            .calendar { gap: 8px; padding-bottom: 6px; }
            .calendar div { padding: 8px 12px; font-size: 0.8rem; min-width: 50px; border-radius: 12px; }
            #streakDisplay { gap: 6px; padding: 8px; border-radius: 16px; }
            .streak-dot { width: 16px; height: 16px; }
            #authPopup { padding: 25px; border-radius: 20px; max-width: 350px; }
            #authPopup h2 { font-size: 1.8rem; margin-bottom: 15px;}
            #authPopup input { padding: 12px; border-radius: 16px; }
            #authPopup button { padding: 12px 25px; border-radius: 20px; }
            #timerDisplay { font-size: 3rem; }
            #timerControls { flex-direction: column; gap: 10px; }
            #pomodoroSettings { flex-direction: column; gap: 8px; }
            #pomodoroSettings input { width: 100px; }
            .achievement-badge { width: 100px; height: 100px; padding: 10px; border-radius: 16px; }
            .achievement-badge .icon { font-size: 2rem; }
            .achievement-badge .name { font-size: 0.8rem; }

            /* Charts on mobile - fixed height and scrollable */
            .chart-wrapper {
                height: 200px; /* Fixed height for mobile charts */
                overflow-y: auto; /* Enable vertical scrolling */
                padding-right: 10px; /* Space for scrollbar */
            }

            /* Mobile: Hide full tab navigation, show mobile toggle */
            #tabNav { display: none; }
            #mobileNavToggle { display: block; position: fixed; top: 15px; left: 15px; z-index: 1001; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay (Spinner with Quote) -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-message">Your Beastie Tracker is Crafting...</div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox" class="text-sm"></div>

    <!-- Confirmation Modal -->
    <div id="confirmModalOverlay" style="display:none;">
        <div id="confirmModal">
            <h3>Are you sure?</h3>
            <p id="confirmMessage" class="text-sm mb-4"></p>
            <div class="button-row">
                <button id="confirmYes" class="clear-btn">Yes</button>
                <button id="confirmNo">No</button>
            </div>
        </div>
    </div>

    <!-- Password Overlay -->
    <div id="authOverlay" style="display:none;">
        <div id="authPopup">
            <h2 id="authTitle">üîê Verify it's you</h2><br>
            <input id="authPass" type="password" placeholder="Enter Password" />
            <button onclick="checkPassword()">Unlock the Beast</button>
        </div>
    </div>

    <!-- Mobile Navigation Toggle (Hamburger) -->
    <button id="mobileNavToggle" onclick="toggleMobileNav()">‚ò∞</button>

    <!-- Mobile Navigation Overlay -->
    <div id="mobileNavOverlay" style="display:none;">
        <button class="close-btn" onclick="toggleMobileNav()">‚úñÔ∏è</button>
        <div class="mobile-nav-links">
            <button class="tab-button" onclick="showTab('logStudySection'); toggleMobileNav();">üìù Log Study</button>
            <button class="tab-button" onclick="showTab('pomodoroSection'); toggleMobileNav();">üçÖ Pomodoro</button>
            <button class="tab-button" onclick="showTab('todoListSection'); toggleMobileNav();">‚úÖ To-Do List</button>
            <button class="tab-button" onclick="showTab('dailyProgressSection'); toggleMobileNav();">üìä Daily Progress</button>
            <button class="tab-button" onclick="showTab('calendarSection'); toggleMobileNav();">üóìÔ∏è Calendar</button>
            <button class="tab-button" onclick="showTab('studyInsightsSection'); toggleMobileNav();">üìà Study Insights</button>
            <button class="tab-button" onclick="showTab('gamificationSection'); toggleMobileNav();">üèÜ Achievements</button>
            <button class="tab-button" onclick="showTab('revisionHubSection'); toggleMobileNav();">üîÑ Revision Hub</button>
            <button class="tab-button" onclick="showTab('aiRecallerSection'); toggleMobileNav();">‚è∞ AI Recaller</button>
            <button class="tab-button" onclick="showTab('aiStudyPlannerSection'); toggleMobileNav();">‚ú® AI Planner</button>
            <button class="tab-button" onclick="showTab('aiAssistantSection'); toggleMobileNav();">üß† AI Assistant</button>
            <button class="tab-button" onclick="showTab('filterExportSection'); toggleMobileNav();">üîç Filter & Export</button>
            <button class="tab-button" onclick="showTab('personalizeSection'); toggleMobileNav();">üé® Personalize</button>
        </div>
    </div>


    <!-- Main Content (initially hidden until unlocked) -->
    <div id="mainContent" class="flex flex-col items-center w-full max-w-4xl px-4" style="display:none;">
        <!-- Header Section with Flexbox -->
        <div class="flex flex-col items-center mb-6">
            <h1>Beastie Tracker</h1>
            <div id="greeting"></div><strong>Version: </strong><i><b>Neo 2 Stable</b></i>
            <div class="quote" id="quote">‚ÄúDon't wish for it, work for it.‚Äù</div>
        </div>
        <div id="clock"></div>

        <!-- Tab Navigation (Desktop Only) -->
        <div id="tabNav">
            <button class="tab-button active" onclick="showTab('logStudySection')">üìù Log Study</button>
            <button class="tab-button" onclick="showTab('pomodoroSection')">üçÖ Pomodoro</button>
            <button class="tab-button" onclick="showTab('todoListSection')">‚úÖ To-Do List</button>
            <button class="tab-button" onclick="showTab('dailyProgressSection')">üìä Daily Progress</button>
            <button class="tab-button" onclick="showTab('calendarSection')">üóìÔ∏è Calendar</button>
            <button class="tab-button" onclick="showTab('studyInsightsSection')">üìà Study Insights</button>
            <button class="tab-button" onclick="showTab('gamificationSection')">üèÜ Achievements</button>
            <button class="tab-button" onclick="showTab('revisionHubSection')">üîÑ Revision Hub</button>
            <button class="tab-button" onclick="showTab('aiRecallerSection')">‚è∞ AI Recaller</button>
            <button class="tab-button" onclick="showTab('aiStudyPlannerSection')">‚ú® AI Planner</button>
            <button class="tab-button" onclick="showTab('aiAssistantSection')">üß† AI Assistant</button>
            <button class="tab-button" onclick="showTab('filterExportSection')">üîç Filter & Export</button>
            <button class="tab-button" onclick="showTab('personalizeSection')">üé® Personalize</button>
        </div>

        <!-- Content Sections -->
        <div id="personalizeSection" class="content-section card w-full mb-6">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üé® Personalize Your Tracker</h2>
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-4">
                <button onclick="toggleDarkMode()" class="text-sm md:text-base">üåì Toggle Light/Dark Mode</button>
                <div class="flex flex-col items-center">
                    <label class="text-sm mb-2 text-[var(--color-text-secondary)]">Choose Accent Color:</label>
                    <div id="accentColorPicker"></div>
                </div>
            </div>
        </div>

        <div id="logStudySection" class="content-section card w-full active">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üìù Log Epic Study</h2>
            <label class="text-sm text-[var(--color-text-secondary)]">Subject</label>
            <select id="subject" class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
                <option value="">Select</option>
                <option>Tamil</option><option>English</option><option>Maths</option><option>Science</option><option>Social Science</option><option>Coding</option><option>General Knowledge</option>
            </select>
            <label class="text-sm text-[var(--color-text-secondary)]">Time Spent (minutes)</label>
            <input id="time" type="number" placeholder="e.g. 45" min="0" class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
            <label class="text-sm text-[var(--color-text-secondary)]">Notes</label>
            <textarea id="notes" rows="2" placeholder="e.g. Chapter 2 revision; challenging topic." class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]"></textarea>
            
            <label class="text-sm text-[var(--color-text-secondary)] block mb-2">Session Time:</label>
            <div class="radio-group mb-4">
                <input name="sessionTime" type="radio" id="morningRadio" value="Morning">
                <label for="morningRadio">üåÖ Morning</label>
                <input name="sessionTime" type="radio" id="eveningRadio" value="Evening">
                <label for="eveningRadio">üåÉ Evening</label>
                <input name="sessionTime" type="radio" id="afternoonRadio" value="Afternoon">
                <label for="afternoonRadio">‚òÄÔ∏è Afternoon</label>
            </div>
            
            <label class="text-sm text-[var(--color-text-secondary)] block mb-2">Study Type:</label>
            <div class="radio-group mb-4">
                <input name="studyType" type="radio" id="newRadio" value="New">
                <label for="newRadio">‚ú® New Study</label>
                <input name="studyType" type="radio" id="revisionRadio" value="Revision">
                <label for="revisionRadio">üîÑ Revision</label>
                <input name="studyType" type="radio" id="practiceRadio" value="Practice">
                <label for="practiceRadio">üß™ Practice</label>
            </div>
            
            <label class="text-sm text-[var(--color-text-secondary)]">Your Mood:</label>
            <select id="mood" class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
                <option value="">Your Mood...</option><option>üòå Calm</option><option>üò§ Focused</option><option>üòñ Tired</option><option>ü§Ø Burnout</option><option>üí° Inspired</option><option>‚ö° Energized</option>
            </select>
            <div id="moodPreview" class="text-base mb-4 text-center text-[var(--color-accent-base)]"></div>
            <div class="button-row flex-col-gap-md md:flex-row-gap-md">
                <button onclick="logStudy()" class="w-full md:w-auto">‚úÖ Log Epic Study</button>
                <button class="clear-btn w-full md:w-auto" onclick="showConfirmClearLogs()">üóëÔ∏è Clear All Logs</button>
            </div>
        </div>

        <div id="pomodoroSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üçÖ Pomodoro Timer</h2>
            <div id="pomodoroTimer">
                <div id="timerDisplay">25:00</div>
                <div id="timerControls">
                    <button id="startTimer">Start</button>
                    <button id="pauseTimer">Pause</button>
                    <button id="resetTimer">Reset</button>
                </div>
                <div id="pomodoroSettings">
                    Study: <input type="number" id="studyMins" value="25" min="1"> min
                    Break: <input type="number" id="breakMins" value="5" min="1"> min
                </div>
            </div>
        </div>

        <div id="todoListSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">‚úÖ Study To-Do List</h2>
            <div id="todoListContainer">
                <input type="text" id="todoInput" placeholder="Add a new study task..." class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
                <button onclick="addTodo()" class="w-full mb-4">‚ûï Add Task</button>
                <div id="todosList">
                    <!-- To-Do items will be rendered here -->
                </div>
            </div>
        </div>

        <div id="dailyProgressSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üìä Daily Progress</h2>
            <div class="stats text-base text-[var(--color-text-primary)] mb-4" id="todayStats"></div>
            <div id="streakDisplay" class="flex items-center justify-center gap-2 mb-4"></div>
            <div class="goals text-base text-[var(--color-text-primary)]">
                <label class="text-sm text-[var(--color-text-secondary)]">Daily Goal (minutes):</label>
                <input id="goalInput" type="number" placeholder="Target mins today" min="0" class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
                <button onclick="setGoal()" class="w-full mb-4">üéØ Set Goal</button>
                <div id="goalProgress"><div id="goalFill"></div></div>
                <p id="goalStatus" class="text-sm text-center text-[var(--color-text-secondary)] mt-2"></p>
            </div>
        </div>

        <div id="calendarSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üóìÔ∏è Study Calendar</h2>
            <div id="monthNav" class="flex justify-between items-center mb-4 text-[var(--color-text-primary)]">
                <button onclick="prevMonth()" class="p-2 rounded-full bg-[var(--color-input-bg)] border border-[var(--color-input-border)] hover:bg-[var(--color-input-border)] transition-colors">‚óÄÔ∏è</button>
                <span id="currentMonthYear" class="text-lg font-semibold"></span>
                <button onclick="nextMonth()" class="p-2 rounded-full bg-[var(--color-input-bg)] border border-[var(--color-input-border)] hover:bg-[var(--color-input-border)] transition-colors">‚ñ∂Ô∏è</button>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center text-[var(--color-text-secondary)]">
                <div class="font-bold">Sun</div><div class="font-bold">Mon</div><div class="font-bold">Tue</div><div class="font-bold">Wed</div><div class="font-bold">Thu</div><div class="font-bold">Fri</div><div class="font-bold">Sat</div>
                <!-- Calendar days will be rendered here -->
            </div>
        </div>

        <div id="studyInsightsSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üìà Study Insights</h2>
            <div id="chartsContainer">
                <div class="chart-wrapper">
                    <h3>Daily Study Time (Last 7 Days)</h3>
                    <canvas id="dailyStudyChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h3>Subject Breakdown (Last 30 Days)</h3>
                    <canvas id="subjectBreakdownChart"></canvas>
                </div>
                 <div class="chart-wrapper">
                    <h3>Mood Trend (Last 7 Days)</h3>
                    <canvas id="moodTrendChart"></canvas>
                </div>
            </div>
        </div>

        <div id="gamificationSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üèÜ Beastie Achievements</h2>
            <div id="levelDisplay">Level: 1 (0 XP)</div>
            <div id="xpProgress"><div id="xpFill"></div></div>
            <p id="xpText" class="text-sm text-[var(--color-text-secondary)] mb-4">Next Level: 100 XP</p>
            <div id="achievementsGrid">
                <!-- Achievement badges will be rendered here -->
            </div>
        </div>

        <!-- Revision Hub Section -->
        <div id="revisionHubSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üîÑ Revision Hub</h2>
            <p class="text-center text-sm text-[var(--color-text-secondary)] mb-4">Mark revisions as complete only on Saturdays or Sundays.</p>
            <div id="pendingRevisionsList" class="flex flex-col gap-3">
                <!-- Pending revisions will be rendered here -->
            </div>
            <h3 class="text-lg font-bold text-center mt-8 mb-4 text-[var(--color-accent-base)]">Completed Revisions</h3>
            <div id="finishedRevisionsList" class="flex flex-col gap-3">
                <!-- Finished revisions will be rendered here -->
            </div>
            <button onclick="clearFinishedRevisions()" class="clear-btn w-full mt-6">üßπ Clear Finished Revisions</button>
        </div>

        <!-- AI Recaller Section (NEW) -->
        <div id="aiRecallerSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">‚è∞ AI Recaller</h2>
            <p class="text-center text-sm text-[var(--color-text-secondary)] mb-4">Your personalized spaced repetition schedule.</p>
            
            <h3 class="text-lg font-bold text-center mt-4 mb-3 text-[var(--color-accent-base)]">Upcoming Recalls</h3>
            <div id="upcomingRecallsList" class="flex flex-col gap-3">
                <!-- Upcoming recalls will be rendered here -->
            </div>

            <h3 class="text-lg font-bold text-center mt-8 mb-3 text-[var(--color-accent-base)]">Overdue Recalls</h3>
            <div id="overdueRecallsList" class="flex flex-col gap-3">
                <!-- Overdue recalls will be rendered here -->
            </div>

            <h3 class="text-lg font-bold text-center mt-8 mb-3 text-[var(--color-accent-base)]">Completed Recalls</h3>
            <div id="completedRecallsList" class="flex flex-col gap-3">
                <!-- Completed recalls will be rendered here -->
            </div>
            <button onclick="clearCompletedRecalls()" class="clear-btn w-full mt-6">üßπ Clear Completed Recalls</button>
        </div>


        <!-- AI Study Planner Section -->
        <div id="aiStudyPlannerSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">‚ú® AI Study Plan Generator</h2>
            <label class="text-sm text-[var(--color-text-secondary)]">Subjects (comma-separated, e.g., Math, Science, History)</label>
            <input type="text" id="plannerSubjects" placeholder="e.g., Algebra, Biology, World History" class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
            
            <label class="text-sm text-[var(--color-text-secondary)]">Total Weekly Study Hours</label>
            <input type="number" id="plannerHours" placeholder="e.g., 15" min="1" class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
            
            <label class="text-sm text-[var(--color-text-secondary)]">Target Exam Date</label>
            <input type="date" id="plannerTargetDate" class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
            
            <button onclick="generateStudyPlan()" class="w-full md:w-auto">üöÄ Generate Study Plan</button>
            
            <div id="studyPlanOutput" class="ai-output-area mt-6">
                <!-- AI generated study plan will appear here -->
            </div>
            <div id="studyPlanLoading" class="ai-loading-indicator" style="display:none;">Generating plan...</div>
        </div>

        <!-- AI Assistant Section -->
        <div id="aiAssistantSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üß† AI Concept Explainer</h2>
            <label class="text-sm text-[var(--color-text-secondary)]">Concept to Explain</label>
            <input type="text" id="conceptInput" placeholder="e.g., Photosynthesis" class="w-full p-3 mb-4 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
            
            <button onclick="explainConcept()" class="w-full md:w-auto">üí° Explain Concept</button>
            
            <div id="conceptExplanationOutput" class="ai-output-area mt-6">
                <!-- AI generated explanation will appear here -->
            </div>
            <div id="conceptLoading" class="ai-loading-indicator" style="display:none;">Thinking...</div>
        </div>


        <div id="filterExportSection" class="content-section card w-full">
            <h2 class="text-xl font-bold text-center mb-4 text-[var(--color-primary)]">üîç Filter & Export Logs</h2>
            <div id="filterSearchContainer">
                <input type="text" id="logSearchInput" placeholder="Search notes..." onkeyup="filterLogs()" class="w-full p-3 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
                <select id="logFilterSubject" onchange="filterLogs()" class="w-full p-3 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
                    <option value="">All Subjects</option>
                    <option>Tamil</option><option>English</option><option>Maths</option><option>Science</option><option>Social Science</option><option>Coding</option><option>General Knowledge</option>
                </select>
                <input type="date" id="logFilterDateStart" onchange="filterLogs()" class="w-full p-3 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
                <input type="date" id="logFilterDateEnd" onchange="filterLogs()" class="w-full p-3 rounded-lg bg-[var(--color-input-bg)] text-[var(--color-text-primary)] border border-[var(--color-input-border)]">
            </div>
            <div class="button-row flex-col-gap-md md:flex-row-gap-md mt-6">
                 <button onclick="exportLogs()" class="w-full md:w-auto">‚¨áÔ∏è Export All Logs</button>
            </div>
            <div id="logListContainer" class="mt-6">
                <!-- Filtered logs will be displayed here -->
            </div>
        </div>

    </div> <!-- End mainContent -->

    <script>
        // Global state variables
        let logs = [];
        let goal = 0;
        let currentTheme = 'dark'; // Default theme
        let currentAccentColor = '#00cfff'; // Default accent color (Cyan)
        let currentAccentColorRGB = '0, 207, 255'; // Default RGB for Cyan
        let pendingRevisions = []; // For the Revision Hub (weekend-only)

        // Pomodoro Timer variables
        let pomodoroTimerInterval;
        let pomodoroTimeLeft; // in seconds
        let pomodoroIsRunning = false;
        let pomodoroCurrentMode = 'study'; // 'study' or 'break'
        let studyDuration = 25 * 60; // Default 25 minutes in seconds
        let breakDuration = 5 * 60;  // Default 5 minutes in seconds

        // To-Do List variables
        let todos = [];

        // Gamification variables
        let userXP = 0;
        let userLevel = 1;
        const XP_PER_LEVEL = 100; // XP needed to level up
        const XP_PER_MINUTE = 1; // XP gained per minute of study

        // Fixed password for the tracker
        const FIXED_PASSWORD = "beastie123";

        // Quotes for dynamic display
        const quotes = [
            "Champions are built in silence.",
            "Focus. Grind. Repeat.",
            "You are what you do, not what you say you'll do.",
            "Make yourself proud.",
            "The only way to do great work is to love what you do.",
            "Success is the sum of small efforts, repeated day in and day out.",
            "Don't wish for it, work for it."
        ];

        // Material You inspired accent colors
        const accentColors = {
            'Cyan': { hex: '#00cfff', rgb: '0, 207, 255' },
            'Purple': { hex: '#8e2de2', rgb: '142, 45, 226' },
            'Green': { hex: '#4CAF50', rgb: '76, 175, 80' },
            'Orange': { hex: '#FF9800', rgb: '255, 152, 0' },
            'Pink': { hex: '#E91E63', rgb: '233, 30, 99' }
        };

        // Achievements definitions
        const achievements = [
            { id: 'first_log', name: 'First Log', icon: '‚ú®', description: 'Logged your first study session.', earned: false, check: () => logs.length >= 1 },
            { id: '7_day_streak', name: '7-Day Streak', icon: 'üî•', description: 'Achieved a 7-day study streak.', earned: false, check: () => calculateStreak() >= 7 },
            { id: 'goal_achiever', name: 'Goal Achiever', icon: 'üéØ', description: 'Completed a daily goal.', earned: false, check: () => {
                const today = new Date().toLocaleDateString();
                const todayLogs = logs.filter(l => l.date === today);
                const total = todayLogs.reduce((a, b) => a + b.time, 0);
                return goal > 0 && total >= goal;
            }},
            { id: '100_minutes', name: '100 Min Master', icon: 'üíØ', description: 'Logged 100+ minutes in a single day.', earned: false, check: () => {
                const today = new Date().toLocaleDateString();
                const todayLogs = logs.filter(l => l.date === today);
                const total = todayLogs.reduce((a, b) => a + b.time, 0);
                return total >= 100;
            }},
            { id: '5_subjects', name: 'Diverse Learner', icon: 'üìö', description: 'Studied 5 different subjects.', earned: false, check: () => {
                const uniqueSubjects = new Set(logs.map(l => l.subj));
                return uniqueSubjects.size >= 5;
            }},
            { id: 'lvl_5', name: 'Level 5 Beast', icon: 'ü¶Å', description: 'Reached Level 5.', earned: false, check: () => userLevel >= 5 },
        ];


        // --- Utility Functions ---
        function showMessage(message, type = 'info', duration = 3000) {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = message;
            msgBox.className = 'text-sm'; // Reset classes
            msgBox.classList.add('show');
            if (type === 'error') msgBox.classList.add('error');
            if (type === 'success') msgBox.classList.add('success');

            setTimeout(() => {
                msgBox.classList.remove('show');
            }, duration);
        }

        function showConfirm(message, onConfirm) {
            const modalOverlay = document.getElementById('confirmModalOverlay');
            const confirmMessage = document.getElementById('confirmMessage');
            confirmMessage.textContent = message;

            modalOverlay.classList.add('show');

            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            // Remove existing listeners to prevent multiple calls
            const newConfirmYes = confirmYes.cloneNode(true);
            confirmYes.parentNode.replaceChild(newConfirmYes, confirmYes);
            const newConfirmNo = confirmNo.cloneNode(true);
            confirmNo.parentNode.replaceChild(newConfirmNo, confirmNo);

            newConfirmYes.addEventListener('click', () => {
                onConfirm(true);
                modalOverlay.classList.remove('show');
            });

            newConfirmNo.addEventListener('click', () => {
                onConfirm(false);
                modalOverlay.classList.remove('show');
            });
        }

        // --- Core UI & Dynamic Content ---
        function rotateQuote() {
            document.getElementById("quote").textContent = "‚Äú" + quotes[Math.floor(Math.random() * quotes.length)] + "‚Äù";
        }
        setInterval(rotateQuote, 60000); // Change quote every minute
        rotateQuote(); // Initial quote

        function updateClock() {
            const now = new Date();
            document.getElementById("clock").textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateClock, 1000); // Update every second
        updateClock(); // Initial clock display

        function greetUser() {
            const hr = new Date().getHours(), g = document.getElementById("greeting");
            if (hr < 12) g.textContent = "üåÖ Good morning, Beastie!";
            else if (hr < 18) g.textContent = "‚òÄÔ∏è Good afternoon!";
            else g.textContent = "üåÉ Good evening, Beastie!";
        }
        greetUser();

        // Mood Preview
        document.getElementById("mood").addEventListener("input", e => {
            document.getElementById("moodPreview").textContent = "Mood: " + e.target.value;
        });

        // --- Theme & Accent Color ---
        function toggleDarkMode() {
            if (currentTheme === 'dark') {
                document.body.classList.add('light-mode');
                currentTheme = 'light';
            } else {
                document.body.classList.remove('light-mode');
                currentTheme = 'dark';
            }
            localStorage.setItem('beastieTheme', currentTheme);
            updateChartColors(); // Update chart colors on theme change
        }

        // Function to convert hex to RGB string
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 0x0000ff;
            return `${r}, ${g}, ${b}`;
        }

        function applyAccentColor(colorName) {
            const colorData = accentColors[colorName];
            if (colorData) {
                document.documentElement.style.setProperty('--color-primary', colorData.hex);
                document.documentElement.style.setProperty('--color-primary-rgb', colorData.rgb);
                
                // Dynamically calculate secondary/tertiary shades for a more cohesive Material You feel
                document.documentElement.style.setProperty('--color-secondary', adjustColor(colorData.hex, -20)); // Darken by 20%
                document.documentElement.style.setProperty('--color-tertiary', adjustColor(colorData.hex, 20)); // Lighten by 20%
                document.documentElement.style.setProperty('--color-accent-base', colorData.hex);
                document.documentElement.style.setProperty('--color-accent-base-rgb', colorData.rgb);

                currentAccentColor = colorData.hex;
                currentAccentColorRGB = colorData.rgb;
                localStorage.setItem('beastieAccentColor', colorName);
                drawAccentColorPicker(); // Re-draw to show selected
                updateChartColors(); // Update chart colors
            }
        }

        // Helper to adjust color brightness (simple version)
        function adjustColor(hex, percent) {
            let f = parseInt(hex.slice(1), 16), t = percent < 0 ? 0 : 255, p = percent < 0 ? percent * -1 : percent, R = f >> 16, G = (f >> 8) & 0x00ff, B = f & 0x0000ff;
            return "#" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + (Math.round((t - G) * p) + G) * 0x100 + (Math.round((t - B) * p) + B)).toString(16).slice(1);
        }

        function drawAccentColorPicker() {
            const pickerContainer = document.getElementById('accentColorPicker');
            pickerContainer.innerHTML = '';
            for (const name in accentColors) {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = accentColors[name].hex;
                swatch.title = name;
                swatch.onclick = () => applyAccentColor(name);
                if (accentColors[name].hex === currentAccentColor) {
                    swatch.classList.add('selected');
                }
                pickerContainer.appendChild(swatch);
            }
        }

        // --- Data Persistence (LocalStorage) ---
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving ${key} to localStorage:`, e);
                showMessage(`Error saving data (${key}). Storage might be full.`, 'error');
            }
        }

        function loadFromLocalStorage(key, defaultValue) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error(`Error loading ${key} from localStorage:`, e);
                showMessage(`Error loading data (${key}). Using default.`, 'error');
                return defaultValue;
            }
        }

        // --- Study Logging ---
        function logStudy() {
            const s = document.getElementById("subject").value;
            const t = parseInt(document.getElementById("time").value);
            const note = document.getElementById("notes").value.trim();
            const session = document.querySelector('input[name="sessionTime"]:checked')?.value;
            const kind = document.querySelector('input[name="studyType"]:checked')?.value; // Changed to 'kind' for consistency with previous
            const mood = document.getElementById("mood").value;

            if (!s || isNaN(t) || t <= 0 || !session || !kind) {
                showMessage("‚ùó Please ensure Subject, Time, Session, and Study Type are all filled in correctly.", 'error');
                return;
            }

            const d = new Date().toLocaleDateString();
            const timestamp = Date.now(); // Add a timestamp for consistent ordering
            const newLogId = 'log_' + timestamp + '_' + Math.random().toString(36).substring(2, 9); // More robust unique ID

            const newLog = { id: newLogId, date: d, subj: s, time: t, session, kind, note, mood, timestamp, recallSchedule: [] };
            logs.unshift(newLog); // Add to the beginning for chronological display
            saveToLocalStorage('beastieLogs', logs); // Save to localStorage

            // Add to pendingRevisions if it's a 'New Study' or 'Practice'
            if (kind === 'New' || kind === 'Practice') {
                pendingRevisions.unshift({
                    id: 'rev_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9), // Unique ID for the revision entry
                    originalLogId: newLogId, // Link to the original study log
                    subject: s,
                    dateLogged: d,
                    notes: note,
                    status: 'pending'
                });
                saveToLocalStorage('pendingRevisions', pendingRevisions);

                // Schedule AI Recaller dates for New Study/Practice
                scheduleRecallDates(newLogId, new Date(timestamp), s, note);
            }

            // Update XP and check for level up
            userXP += (t * XP_PER_MINUTE);
            checkLevelUp();
            saveToLocalStorage('beastieXP', userXP);
            saveToLocalStorage('beastieLevel', userLevel);

            checkAchievements(); // Check for new achievements
            updateAll(); // Refresh all UI elements
            showMessage("‚úÖ Epic Study Logged!", 'success');
            
            // Clear inputs after logging
            document.getElementById("subject").selectedIndex = 0;
            document.getElementById("time").value = "";
            document.getElementById("notes").value = "";
            document.querySelectorAll('input[name="sessionTime"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('input[name="studyType"]').forEach(radio => radio.checked = false);
            document.getElementById("mood").selectedIndex = 0;
            document.getElementById("moodPreview").textContent = "";
        }

        function showConfirmClearLogs() {
            showConfirm("üö® Are you sure you want to clear ALL study logs? This cannot be undone!", (confirmed) => {
                if (confirmed) {
                    clearHistory();
                }
            });
        }

        function clearHistory() {
            logs = [];
            pendingRevisions = []; // Clear revisions too
            localStorage.removeItem('beastieLogs'); // Clear from localStorage
            localStorage.removeItem('pendingRevisions'); // Clear revisions from localStorage
            userXP = 0; // Reset XP
            userLevel = 1; // Reset Level
            achievements.forEach(a => a.earned = false); // Reset achievements
            saveToLocalStorage('beastieXP', userXP);
            saveToLocalStorage('beastieLevel', userLevel);
            saveToLocalStorage('beastieAchievements', achievements);
            updateAll();
            showMessage("üóëÔ∏è All logs cleared!", 'success');
        }

        // --- Data Analysis & Display ---
        function updateStats() {
            const today = new Date().toLocaleDateString();
            const todayLogs = logs.filter(l => l.date === today);
            const total = todayLogs.reduce((a, b) => a + b.time, 0);
            const bySub = {};
            todayLogs.forEach(l => bySub[l.subj] = (bySub[l.subj] || 0) + l.time);

            let txt = `‚ö° Today's Beast Mode: <strong>${total} minutes</strong>`;
            for (let s in bySub) txt += ` ‚Ä¢ ${s}: ${bySub[s]} min`;
            
            document.getElementById("todayStats").innerHTML = txt; // Use innerHTML for bold
        }

        function calculateStreak() {
            const sortedLogs = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
            const uniqueDates = [...new Set(sortedLogs.map(l => new Date(l.date).toLocaleDateString()))];

            let currentStreak = 0;
            let lastDate = new Date();
            lastDate.setHours(0,0,0,0); // Normalize to start of day

            // Check if today has logs. If not, and yesterday has logs, start streak check from yesterday.
            const todayHasLogs = uniqueDates.includes(lastDate.toLocaleDateString());
            if (!todayHasLogs && uniqueDates.length > 0) {
                const latestLogDate = new Date(uniqueDates[uniqueDates.length - 1]);
                latestLogDate.setHours(0,0,0,0);
                const yesterday = new Date(lastDate);
                yesterday.setDate(lastDate.getDate() - 1);
                if (latestLogDate.getTime() === yesterday.getTime()) {
                    lastDate.setDate(lastDate.getDate() - 1); // Adjust lastDate to yesterday to start streak
                } else if (latestLogDate.getTime() < lastDate.getTime()) {
                    // This condition means the latest log is older than yesterday, so streak is 0
                    return 0; 
                }
            }

            for (let i = uniqueDates.length - 1; i >= 0; i--) {
                const logDate = new Date(uniqueDates[i]);
                logDate.setHours(0,0,0,0); // Normalize log date

                if (logDate.getTime() === lastDate.getTime()) {
                    currentStreak++;
                    lastDate.setDate(lastDate.getDate() - 1); // Move to previous day
                } else if (logDate.getTime() < lastDate.getTime()) {
                    break; // If there's a gap, break the streak
                }
            }
            return currentStreak;
        }

        function updateStreak() {
            streak = calculateStreak();
            drawStreakVisual();
        }

        function drawStreakVisual() {
            const streakDisplay = document.getElementById("streakDisplay");
            streakDisplay.innerHTML = ''; // Clear previous dots
            const maxDots = 7; // Display up to 7 streak days visually
            const effectiveStreak = Math.min(streak, maxDots);

            if (streak > 0) {
                const prefix = document.createElement('span');
                prefix.textContent = `üî• Streak: ${streak} days `;
                prefix.classList.add('font-semibold', 'text-[var(--color-text-primary)]');
                streakDisplay.appendChild(prefix);

                for (let i = 0; i < maxDots; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('streak-dot');
                    if (i < effectiveStreak) {
                        dot.classList.add('active');
                    }
                    streakDisplay.appendChild(dot);
                }
            } else {
                streakDisplay.innerHTML = `<span class="opacity-80 italic text-[var(--color-text-secondary)]">No active streak. Log some study!</span>`;
            }
        }

        function setGoal() {
            goal = parseInt(document.getElementById("goalInput").value) || 0;
            saveToLocalStorage('beastieGoal', goal); // Save to localStorage
            updateGoal(); // Update UI immediately
            showMessage(`üéØ Daily goal set to ${goal} minutes!`, 'success');
        }

        function updateGoal() {
            const today = new Date().toLocaleDateString();
            const tot = logs.filter(l => l.date === today).reduce((a, b) => a + b.time, 0);
            const goalFill = document.getElementById("goalFill");
            
            let percentage = goal > 0 ? Math.min(100, (tot / goal) * 100) : 0;
            goalFill.style.width = percentage + "%";

            if (percentage >= 100 && goal > 0) {
                goalFill.classList.add('complete');
            } else {
                goalFill.classList.remove('complete');
            }
            // Display goal progress visually
            const goalContainer = document.querySelector(".goals"); // Changed to select the parent .goals div
            let goalStatus = document.getElementById("goalStatus");
            if (!goalStatus) {
                goalStatus = document.createElement('p');
                goalStatus.id = "goalStatus";
                goalStatus.classList.add('mt-2', 'text-center', 'text-sm', 'text-[var(--color-text-secondary)]');
                goalContainer.appendChild(goalStatus);
            }
            if (goal > 0) {
                goalStatus.textContent = `${tot} / ${goal} minutes - ${percentage.toFixed(0)}%`;
                if (percentage >= 100) {
                    goalStatus.innerHTML += ' üéâ <i>Goal Achieved!</i>';
                }
            } else {
                goalStatus.textContent = 'Set a daily goal above!';
            }
        }

        // --- Calendar ---
        let currentCalendarDate = new Date();

        function drawCalendar() {
            const calGrid = document.getElementById("calendarGrid");
            calGrid.innerHTML = `
                <div class="font-bold text-[var(--color-text-primary)]">Sun</div>
                <div class="font-bold text-[var(--color-text-primary)]">Mon</div>
                <div class="font-bold text-[var(--color-text-primary)]">Tue</div>
                <div class="font-bold text-[var(--color-text-primary)]">Wed</div>
                <div class="font-bold text-[var(--color-text-primary)]">Thu</div>
                <div class="font-bold text-[var(--color-text-primary)]">Fri</div>
                <div class="font-bold text-[var(--color-text-primary)]">Sat</div>
            `; // Clear and add day names

            document.getElementById("currentMonthYear").textContent = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            // Add empty divs for leading blank days
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDiv = document.createElement("div");
                calGrid.appendChild(emptyDiv);
            }

            const todayFullDate = new Date().toLocaleDateString();
            const logsByDate = logs.reduce((acc, log) => {
                acc[log.date] = acc[log.date] || [];
                acc[log.date].push(log);
                return acc;
            }, {});

            for (let day = 1; day <= numDaysInMonth; day++) {
                const d = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                const div = document.createElement("div");
                div.textContent = day;
                div.classList.add('p-2', 'rounded-lg', 'cursor-pointer', 'transition-all', 'duration-300', 'ease-in-out', 'hover:scale-105', 'hover:shadow-lg', 'bg-[var(--color-input-bg)]', 'text-[var(--color-text-primary)]', 'border', 'border-[var(--color-input-border)]');

                const dateString = d.toLocaleDateString();
                if (dateString === todayFullDate) {
                    div.classList.add("today");
                }

                const dayLogs = logsByDate[dateString];
                if (dayLogs && dayLogs.length > 0) {
                    div.classList.add('has-study');
                    const totalStudyForDay = dayLogs.reduce((sum, log) => sum + log.time, 0);
                    if (goal > 0 && totalStudyForDay >= goal) {
                        div.classList.add('goal-achieved');
                    }
                }

                div.onclick = () => {
                    const list = (dayLogs || [])
                        .map(l => `Subject: ${l.subj}\nTime: ${l.time}min\nSession: ${l.session}\nType: ${l.kind}${l.mood ? `\nMood: ${l.mood}` : ""}${l.note ? `\nNotes: ${l.note}` : ""}`)
                        .join("\n\n") || "No logs for this day.";
                    showMessage(`Logs for ${dateString}:\n\n${list}`, 'info', 5000); // Use custom message box
                };
                calGrid.appendChild(div);
            }
        }

        function prevMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            drawCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            drawCalendar();
        }

        // --- Export Logs ---
        function exportLogs() {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([JSON.stringify(logs, null, 2)], { type: "application/json" })); // Pretty print JSON
            a.download = "beastie_logs.json";
            a.click();
            showMessage("Logs exported as beastie_logs.json!", 'success');
        }

        // --- Pomodoro Timer Functions ---
        function updateTimerDisplay() {
            const minutes = Math.floor(pomodoroTimeLeft / 60);
            const seconds = pomodoroTimeLeft % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            if (pomodoroIsRunning) return;
            pomodoroIsRunning = true;
            document.getElementById('startTimer').textContent = 'Resume'; // Change button text
            showMessage(`Pomodoro ${pomodoroCurrentMode} started!`, 'info');

            pomodoroTimerInterval = setInterval(() => {
                pomodoroTimeLeft--;
                updateTimerDisplay();

                if (pomodoroTimeLeft <= 0) {
                    clearInterval(pomodoroTimerInterval);
                    pomodoroIsRunning = false;
                    
                    if (pomodoroCurrentMode === 'study') {
                        // Log the study session automatically
                        const d = new Date().toLocaleDateString();
                        const timestamp = Date.now();
                        const newLogId = 'log_' + timestamp + '_' + Math.random().toString(36).substring(2, 9);
                        logs.unshift({
                            id: newLogId,
                            date: d,
                            subj: 'Pomodoro Session',
                            time: studyDuration / 60, // Log actual study minutes
                            session: 'Pomodoro',
                            kind: 'Focused Study',
                            note: `Completed a ${studyDuration / 60}-minute Pomodoro session.`,
                            mood: 'Focused', // Default mood for auto-logged sessions
                            timestamp: timestamp,
                            recallSchedule: [] // Pomodoro sessions don't need recall
                        });
                        saveToLocalStorage('beastieLogs', logs);
                        userXP += (studyDuration / 60 * XP_PER_MINUTE);
                        checkLevelUp();
                        saveToLocalStorage('beastieXP', userXP);
                        saveToLocalStorage('beastieLevel', userLevel);
                        checkAchievements();
                        updateAll();
                        showMessage(`üéâ Pomodoro Study Session Complete! Took a ${studyDuration / 60} min session.`, 'success', 5000);
                        pomodoroCurrentMode = 'break';
                        pomodoroTimeLeft = breakDuration;
                        showMessage(`Time for a ${breakDuration / 60}-minute break!`, 'info', 3000);
                    } else {
                        pomodoroCurrentMode = 'study';
                        pomodoroTimeLeft = studyDuration;
                        showMessage('Break finished! Ready for next study session.', 'info', 3000);
                    }
                    updateTimerDisplay();
                    document.getElementById('startTimer').textContent = 'Start'; // Reset button text
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(pomodoroTimerInterval);
            pomodoroIsRunning = false;
            document.getElementById('startTimer').textContent = 'Resume';
            showMessage('Timer paused.', 'info');
        }

        function resetTimer() {
            clearInterval(pomodoroTimerInterval);
            pomodoroIsRunning = false;
            pomodoroCurrentMode = 'study';
            studyDuration = parseInt(document.getElementById('studyMins').value) * 60 || (25 * 60);
            breakDuration = parseInt(document.getElementById('breakMins').value) * 60 || (5 * 60);
            pomodoroTimeLeft = studyDuration;
            updateTimerDisplay();
            document.getElementById('startTimer').textContent = 'Start';
            showMessage('Timer reset.', 'info');
            saveToLocalStorage('pomodoroSettings', { study: studyDuration / 60, break: breakDuration / 60 });
        }

        // Load Pomodoro settings from localStorage
        function loadPomodoroSettings() {
            const savedSettings = loadFromLocalStorage('pomodoroSettings', { study: 25, break: 5 });
            document.getElementById('studyMins').value = savedSettings.study;
            document.getElementById('breakMins').value = savedSettings.break;
            studyDuration = savedSettings.study * 60;
            breakDuration = savedSettings.break * 60;
            pomodoroTimeLeft = studyDuration;
            updateTimerDisplay();
        }

        // --- To-Do List Functions ---
        function addTodo() {
            const todoInput = document.getElementById('todoInput');
            const taskText = todoInput.value.trim();
            if (taskText) {
                todos.push({ id: Date.now(), text: taskText, completed: false });
                saveToLocalStorage('beastieTodos', todos);
                renderTodos();
                todoInput.value = '';
                showMessage('Task added!', 'success');
            } else {
                showMessage('Please enter a task.', 'error');
            }
        }

        function toggleTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                saveToLocalStorage('beastieTodos', todos);
                renderTodos();
                showMessage(`Task ${todo.completed ? 'completed' : 'reopened'}!`, 'info');
            }
        }

        function deleteTodo(id) {
            showConfirm("Are you sure you want to delete this task?", (confirmed) => {
                if (confirmed) {
                    todos = todos.filter(t => t.id !== id);
                    saveToLocalStorage('beastieTodos', todos);
                    renderTodos();
                    showMessage('Task deleted!', 'success');
                }
            });
        }

        function renderTodos() {
            const todosList = document.getElementById('todosList');
            todosList.innerHTML = '';
            if (todos.length === 0) {
                todosList.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] italic">No tasks yet. Add some!</p>';
                return;
            }
            todos.forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                todoItem.innerHTML = `
                    <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${todo.id})">
                    <span>${todo.text}</span>
                    <button onclick="deleteTodo(${todo.id})">‚úñÔ∏è</button>
                `;
                todosList.appendChild(todoItem);
            });
        }

        // --- Charting Functions (Chart.js) ---
        let dailyStudyChartInstance, subjectBreakdownChartInstance, moodTrendChartInstance;

        function updateChartColors() {
            const chartFontColor = getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary');
            const chartGridColor = getComputedStyle(document.documentElement).getPropertyValue('--color-input-border');
            const chartAccentColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent-base');
            const chartAccentColorRGB = getComputedStyle(document.documentElement).getPropertyValue('--color-accent-base-rgb');

            if (dailyStudyChartInstance) {
                dailyStudyChartInstance.options.scales.x.ticks.color = chartFontColor;
                dailyStudyChartInstance.options.scales.y.ticks.color = chartFontColor;
                dailyStudyChartInstance.options.scales.x.grid.color = chartGridColor;
                dailyStudyChartInstance.options.scales.y.grid.color = chartGridColor;
                dailyStudyChartInstance.data.datasets[0].borderColor = chartAccentColor;
                dailyStudyChartInstance.data.datasets[0].backgroundColor = `rgba(${chartAccentColorRGB}, 0.3)`;
                dailyStudyChartInstance.update();
            }
            if (subjectBreakdownChartInstance) {
                subjectBreakdownChartInstance.options.plugins.legend.labels.color = chartFontColor;
                subjectBreakdownChartInstance.update();
            }
             if (moodTrendChartInstance) {
                moodTrendChartInstance.options.scales.x.ticks.color = chartFontColor;
                moodTrendChartInstance.options.scales.y.ticks.color = chartFontColor;
                moodTrendChartInstance.options.scales.x.grid.color = chartGridColor;
                moodTrendChartInstance.options.scales.y.grid.color = chartGridColor;
                moodTrendChartInstance.data.datasets[0].borderColor = chartAccentColor;
                moodTrendChartInstance.data.datasets[0].backgroundColor = `rgba(${chartAccentColorRGB}, 0.3)`;
                moodTrendChartInstance.update();
            }
        }

        function renderCharts() {
            // Daily Study Chart (Last 7 Days)
            const dailyCtx = document.getElementById('dailyStudyChart').getContext('2d');
            const last7Days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i)); // Get last 7 days including today
                return d.toLocaleDateString();
            });
            const dailyData = last7Days.map(date => {
                return logs.filter(l => l.date === date).reduce((sum, l) => sum + l.time, 0);
            });

            if (dailyStudyChartInstance) dailyStudyChartInstance.destroy();
            dailyStudyChartInstance = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => new Date(d).getDate()), // Show just day number
                    datasets: [{
                        label: 'Minutes Studied',
                        data: dailyData,
                        borderColor: currentAccentColor,
                        backgroundColor: `rgba(${currentAccentColorRGB}, 0.3)`,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-input-border') },
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary') }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-input-border') },
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary') }
                        }
                    }
                }
            });

            // Subject Breakdown Chart (Last 30 Days)
            const subjectCtx = document.getElementById('subjectBreakdownChart').getContext('2d');
            const last30DaysLogs = logs.filter(l => (Date.now() - new Date(l.timestamp)) < (30 * 24 * 60 * 60 * 1000));
            const subjectData = last30DaysLogs.reduce((acc, log) => {
                acc[log.subj] = (acc[log.subj] || 0) + log.time;
                return acc;
            }, {});
            const subjectLabels = Object.keys(subjectData);
            const subjectValues = Object.values(subjectData);

            const dynamicColors = subjectLabels.map((_, i) => `hsl(${i * 60}, 70%, 60%)`); // Generate distinct colors

            if (subjectBreakdownChartInstance) subjectBreakdownChartInstance.destroy();
            subjectBreakdownChartInstance = new Chart(subjectCtx, {
                type: 'doughnut',
                data: {
                    labels: subjectLabels,
                    datasets: [{
                        data: subjectValues,
                        backgroundColor: dynamicColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary')
                            }
                        }
                    }
                }
            });

            // Mood Trend Chart (Last 7 Days)
            const moodCtx = document.getElementById('moodTrendChart').getContext('2d');
            const moodMap = {
                'üòå Calm': 1, 'üò§ Focused': 2, 'üí° Inspired': 3, '‚ö° Energized': 4,
                'üòñ Tired': -1, 'ü§Ø Burnout': -2, '': 0 // Map moods to numerical values
            };
            const reverseMoodMap = {
                '-2': 'ü§Ø Burnout', '-1': 'üòñ Tired', '0': 'N/A', '1': 'üòå Calm', '2': 'üò§ Focused', '3': 'üí° Inspired', '4': '‚ö° Energized'
            };

            const moodDataPoints = last7Days.map(date => {
                const dayLogs = logs.filter(l => l.date === date && l.mood);
                if (dayLogs.length === 0) return 0; // No mood logged for this day
                const avgMood = dayLogs.reduce((sum, l) => sum + (moodMap[l.mood] || 0), 0) / dayLogs.length;
                return avgMood;
            });

            if (moodTrendChartInstance) moodTrendChartInstance.destroy();
            moodTrendChartInstance = new Chart(moodCtx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => new Date(d).getDate()),
                    datasets: [{
                        label: 'Average Mood',
                        data: moodDataPoints,
                        borderColor: currentAccentColor,
                        backgroundColor: `rgba(${currentAccentColorRGB}, 0.3)`,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-input-border') },
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary') }
                        },
                        y: {
                            beginAtZero: false, // Mood can be negative
                            min: -2,
                            max: 4,
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-input-border') },
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary'),
                                callback: function(value) {
                                    return reverseMoodMap[value] || value; // Display mood labels
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Gamification Functions ---
        function checkLevelUp() {
            const currentLevelXPNeeded = userLevel * XP_PER_LEVEL;
            if (userXP >= currentLevelXPNeeded) {
                userLevel++;
                userXP -= currentLevelXPNeeded; // Carry over remaining XP
                showMessage(`üéâ LEVEL UP! You are now Level ${userLevel}!`, 'success', 4000);
                // Recursively check if enough XP for next level immediately
                checkLevelUp();
            }
            updateGamificationDisplay();
        }

        function updateGamificationDisplay() {
            document.getElementById('levelDisplay').textContent = `Level: ${userLevel} (${userXP} XP)`;
            const nextLevelXPNeeded = userLevel * XP_PER_LEVEL;
            const xpPercentage = (userXP / nextLevelXPNeeded) * 100;
            document.getElementById('xpFill').style.width = `${xpPercentage}%`;
            document.getElementById('xpText').textContent = `Next Level: ${nextLevelXPNeeded - userXP} XP to Level ${userLevel + 1}`;
            renderAchievements();
        }

        function checkAchievements() {
            let newAchievementEarned = false;
            achievements.forEach(ach => {
                if (!ach.earned && ach.check()) {
                    ach.earned = true;
                    newAchievementEarned = true;
                    showMessage(`üèÜ Achievement Unlocked: ${ach.name}!`, 'success', 5000);
                }
            });
            if (newAchievementEarned) {
                saveToLocalStorage('beastieAchievements', achievements);
                renderAchievements();
            }
        }

        function renderAchievements() {
            const achievementsGrid = document.getElementById('achievementsGrid');
            achievementsGrid.innerHTML = '';
            achievements.forEach(ach => {
                const badge = document.createElement('div');
                badge.className = `achievement-badge ${ach.earned ? 'earned' : ''}`;
                badge.innerHTML = `
                    <span class="icon">${ach.icon}</span>
                    <span class="name">${ach.name}</span>
                    <p class="text-xs text-[var(--color-text-secondary)] mt-1">${ach.description}</p>
                `;
                achievementsGrid.appendChild(badge);
            });
        }

        // --- Filter & Search Logs ---
        function filterLogs() {
            const searchText = document.getElementById('logSearchInput').value.toLowerCase();
            const filterSubject = document.getElementById('logFilterSubject').value;
            const filterDateStart = document.getElementById('logFilterDateStart').value;
            const filterDateEnd = document.getElementById('logFilterDateEnd').value;

            const filtered = logs.filter(log => {
                const matchesSearch = log.note.toLowerCase().includes(searchText) ||
                                      log.subj.toLowerCase().includes(searchText) ||
                                      log.session.toLowerCase().includes(searchText) ||
                                      log.kind.toLowerCase().includes(searchText) ||
                                      (log.mood ? log.mood.toLowerCase().includes(searchText) : false);
                const matchesSubject = filterSubject === "" || log.subj === filterSubject;

                let matchesDate = true;
                if (filterDateStart) {
                    const startDate = new Date(filterDateStart);
                    const logDate = new Date(log.date);
                    matchesDate = matchesDate && (logDate.setHours(0,0,0,0) >= startDate.setHours(0,0,0,0));
                }
                if (filterDateEnd) {
                    const endDate = new Date(filterDateEnd);
                    const logDate = new Date(log.date);
                    matchesDate = matchesDate && (logDate.setHours(0,0,0,0) <= endDate.setHours(0,0,0,0));
                }
                return matchesSearch && matchesSubject && matchesDate;
            });
            renderFilteredLogs(filtered);
        }

        function renderFilteredLogs(filteredLogs) {
            const logListContainer = document.getElementById('logListContainer');
            logListContainer.innerHTML = '';
            if (filteredLogs.length === 0) {
                logListContainer.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] italic">No logs match your filters.</p>';
                return;
            }
            filteredLogs.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerHTML = `
                    <p><strong>Date:</strong> ${log.date} | <strong>Subject:</strong> ${log.subj} | <strong>Time:</strong> ${log.time} min</p>
                    <p><em>Session:</em> ${log.session} | <em>Type:</em> ${log.kind} | <em>Mood:</em> ${log.mood || 'N/A'}</p>
                    ${log.note ? `<p><em>Notes:</em> ${log.note}</p>` : ''}
                `;
                logListContainer.appendChild(entry);
            });
        }

        // --- Tab Management ---
        let activeTabId = 'logStudySection'; // Default active tab is now Log Study

        function showTab(tabId) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none'; // Ensure it's truly hidden
            });

            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected content section
            const selectedSection = document.getElementById(tabId);
            if (selectedSection) {
                selectedSection.classList.add('active');
                selectedSection.style.display = 'block'; // Make it visible
                activeTabId = tabId; // Update active tab ID
            }

            // Activate the clicked tab button
            const clickedButton = document.querySelector(`.tab-button[onclick*="showTab('${tabId}')"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // Re-render charts/revisions/recalls if their tabs are activated
            if (tabId === 'studyInsightsSection') {
                renderCharts();
            } else if (tabId === 'revisionHubSection') {
                renderRevisionHub();
            } else if (tabId === 'aiRecallerSection') { // New: Render AI Recaller
                renderAIRecaller();
            } else if (tabId === 'todoListSection') {
                renderTodos();
            } else if (tabId === 'dailyProgressSection') {
                updateStats();
                updateGoal();
                updateStreak();
            } else if (tabId === 'calendarSection') {
                drawCalendar();
            } else if (tabId === 'filterExportSection') {
                filterLogs();
            }
            // No specific re-render needed for AI Planner/Assistant on show, as they render on button click
        }

        // --- Mobile Navigation Toggle ---
        function toggleMobileNav() {
            const mobileNavOverlay = document.getElementById('mobileNavOverlay');
            if (mobileNavOverlay.classList.contains('show')) {
                mobileNavOverlay.classList.remove('show');
                setTimeout(() => { mobileNavOverlay.style.display = 'none'; }, 300); // Match CSS transition
            } else {
                mobileNavOverlay.style.display = 'flex';
                setTimeout(() => { mobileNavOverlay.classList.add('show'); }, 10); // Small delay for transition to apply
            }
        }


        // --- Revision Hub Functions ---
        function renderRevisionHub() {
            const pendingList = document.getElementById('pendingRevisionsList');
            const finishedList = document.getElementById('finishedRevisionsList');
            pendingList.innerHTML = '';
            finishedList.innerHTML = '';

            const pending = pendingRevisions.filter(rev => rev.status === 'pending');
            const finished = pendingRevisions.filter(rev => rev.status === 'finished');

            if (pending.length === 0) {
                pendingList.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] italic">No pending revisions. Great job!</p>';
            } else {
                pending.forEach(rev => {
                    const item = document.createElement('div');
                    item.className = 'revision-item';
                    item.innerHTML = `
                        <p><strong>Subject:</strong> ${rev.subject}</p>
                        <p><em>Logged On:</em> ${rev.dateLogged}</p>
                        ${rev.notes ? `<p><em>Notes:</em> ${rev.notes}</p>` : ''}
                        <button class="mark-button" onclick="markAsRevised('${rev.id}')">Mark as Revised</button>
                    `;
                    pendingList.appendChild(item);
                });
            }

            if (finished.length === 0) {
                finishedList.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] italic">No completed revisions yet.</p>';
            } else {
                finished.forEach(rev => {
                    const item = document.createElement('div');
                    item.className = 'revision-item finished';
                    item.innerHTML = `
                        <p><strong>Subject:</strong> ${rev.subject}</p>
                        <p><em>Logged On:</em> ${rev.dateLogged}</p>
                        <p><em>Revised On:</em> ${rev.dateFinished}</p>
                        ${rev.notes ? `<p><em>Notes:</em> ${rev.notes}</p>` : ''}
                        <button class="mark-button" disabled>Revised</button>
                    `;
                    finishedList.appendChild(item);
                });
            }
        }

        function markAsRevised(revisionId) {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 for Sunday, 6 for Saturday

            if (dayOfWeek === 0 || dayOfWeek === 6) { // It's Sunday or Saturday
                const revisionIndex = pendingRevisions.findIndex(rev => rev.id === revisionId);
                if (revisionIndex > -1) {
                    pendingRevisions[revisionIndex].status = 'finished';
                    pendingRevisions[revisionIndex].dateFinished = today.toLocaleDateString();
                    saveToLocalStorage('pendingRevisions', pendingRevisions);
                    renderRevisionHub();
                    showMessage('Revision marked as finished! üéâ', 'success');
                }
            } else {
                showMessage('Revisions can only be marked as finished on Saturdays or Sundays. Keep studying!', 'info');
            }
        }

        function clearFinishedRevisions() {
            showConfirm("Are you sure you want to clear ALL completed revisions?", (confirmed) => {
                if (confirmed) {
                    pendingRevisions = pendingRevisions.filter(rev => rev.status === 'pending');
                    saveToLocalStorage('pendingRevisions', pendingRevisions);
                    renderRevisionHub();
                    showMessage('Finished revisions cleared!', 'success');
                }
            });
        }

        // Function to ensure all 'New' or 'Practice' logs have a corresponding pending revision
        function syncLogsToRevisions() {
            logs.forEach(log => {
                if ((log.kind === 'New' || log.kind === 'Practice') &&
                    !pendingRevisions.some(rev => rev.originalLogId === log.id)) {
                    // Add a new pending revision for this log if it doesn't exist
                    pendingRevisions.unshift({
                        id: 'rev_' + Date.now() + Math.random().toString(36).substring(2, 9), // More robust unique ID
                        originalLogId: log.id,
                        subject: log.subj,
                        dateLogged: log.date,
                        notes: log.note,
                        status: 'pending'
                    });
                }
                // Also ensure recallSchedule is initialized for old logs that might not have it
                if (!log.recallSchedule) {
                    log.recallSchedule = [];
                    // For existing logs, don't auto-schedule, user can manually trigger if needed
                    // or we could add a "Generate Recalls" button per log entry.
                    // For now, just initialize the array.
                }
            });
            saveToLocalStorage('beastieLogs', logs); // Save logs with new recallSchedule property
            saveToLocalStorage('pendingRevisions', pendingRevisions);
        }

        // --- AI Recaller Functions (NEW) ---
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function scheduleRecallDates(logId, originalStudyDate, subject, notes) {
            // Spaced repetition intervals: Day 3, Day 7, Day 30, Day 90, Day 180, Day 365
            const intervals = [3, 7, 30, 90, 180, 365]; 
            const log = logs.find(l => l.id === logId);

            if (log) {
                log.recallSchedule = intervals.map(days => {
                    const recallDate = addDays(originalStudyDate, days).toLocaleDateString();
                    return {
                        recallId: logId + '_recall_' + days, // Unique ID for each recall instance
                        date: recallDate,
                        status: 'pending', // 'pending', 'overdue', 'completed'
                        interval: `Day ${days}`,
                        subject: subject,
                        notes: notes
                    };
                });
                saveToLocalStorage('beastieLogs', logs);
            }
        }

        function renderAIRecaller() {
            const upcomingList = document.getElementById('upcomingRecallsList');
            const overdueList = document.getElementById('overdueRecallsList');
            const completedList = document.getElementById('completedRecallsList');
            
            upcomingList.innerHTML = '';
            overdueList.innerHTML = '';
            completedList.innerHTML = '';

            const today = new Date();
            today.setHours(0,0,0,0); // Normalize today's date

            let allRecalls = [];
            logs.forEach(log => {
                if (log.recallSchedule) {
                    allRecalls = allRecalls.concat(log.recallSchedule.map(recall => ({
                        ...recall,
                        originalLogId: log.id, // Link back to original log
                        originalLogDate: log.date // Original study date for context
                    })));
                }
            });

            // Sort recalls by date
            allRecalls.sort((a, b) => new Date(a.date) - new Date(b.date));

            const upcoming = [];
            const overdue = [];
            const completed = [];

            allRecalls.forEach(recall => {
                const recallDate = new Date(recall.date);
                recallDate.setHours(0,0,0,0);

                if (recall.status === 'completed') {
                    completed.push(recall);
                } else if (recallDate < today) {
                    recall.status = 'overdue'; // Mark as overdue if date passed
                    overdue.push(recall);
                } else {
                    upcoming.push(recall);
                }
            });
            saveToLocalStorage('beastieLogs', logs); // Save logs with updated recall statuses

            // Render Upcoming Recalls
            if (upcoming.length === 0) {
                upcomingList.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] italic">No upcoming recalls scheduled.</p>';
            } else {
                upcoming.forEach(recall => {
                    const item = document.createElement('div');
                    item.className = 'recall-item';
                    item.innerHTML = `
                        <p><strong>Subject:</strong> ${recall.subject} (${recall.interval})</p>
                        <p><em>Original Study:</em> ${recall.originalLogDate}</p>
                        <p><em>Recall Date:</em> ${recall.date}</p>
                        ${recall.notes ? `<p><em>Notes:</em> ${recall.notes}</p>` : ''}
                        <button class="mark-button" onclick="markRecallAsCompleted('${recall.originalLogId}', '${recall.recallId}')">Mark as Recalled</button>
                    `;
                    upcomingList.appendChild(item);
                });
            }

            // Render Overdue Recalls
            if (overdue.length === 0) {
                overdueList.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] italic">No overdue recalls. You\'re on track!</p>';
            } else {
                overdue.forEach(recall => {
                    const item = document.createElement('div');
                    item.className = 'recall-item overdue';
                    item.innerHTML = `
                        <p><strong>Subject:</strong> ${recall.subject} (${recall.interval})</p>
                        <p><em>Original Study:</em> ${recall.originalLogDate}</p>
                        <p><em>Overdue Since:</em> ${recall.date}</p>
                        ${recall.notes ? `<p><em>Notes:</em> ${recall.notes}</p>` : ''}
                        <button class="mark-button" onclick="markRecallAsCompleted('${recall.originalLogId}', '${recall.recallId}')">Mark as Recalled</button>
                    `;
                    overdueList.appendChild(item);
                });
            }

            // Render Completed Recalls
            if (completed.length === 0) {
                completedList.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] italic">No completed recalls yet.</p>';
            } else {
                completed.forEach(recall => {
                    const item = document.createElement('div');
                    item.className = 'recall-item completed';
                    item.innerHTML = `
                        <p><strong>Subject:</strong> ${recall.subject} (${recall.interval})</p>
                        <p><em>Original Study:</em> ${recall.originalLogDate}</p>
                        <p><em>Completed On:</em> ${recall.dateCompleted}</p>
                        ${recall.notes ? `<p><em>Notes:</em> ${recall.notes}</p>` : ''}
                        <button class="mark-button" disabled>Recalled</button>
                    `;
                    completedList.appendChild(item);
                });
            }
        }

        function markRecallAsCompleted(originalLogId, recallId) {
            const logIndex = logs.findIndex(l => l.id === originalLogId);
            if (logIndex > -1) {
                const recallIndex = logs[logIndex].recallSchedule.findIndex(r => r.recallId === recallId);
                if (recallIndex > -1) {
                    logs[logIndex].recallSchedule[recallIndex].status = 'completed';
                    logs[logIndex].recallSchedule[recallIndex].dateCompleted = new Date().toLocaleDateString();
                    saveToLocalStorage('beastieLogs', logs);
                    renderAIRecaller();
                    showMessage('Recall marked as completed! ‚úÖ', 'success');
                }
            }
        }

        function clearCompletedRecalls() {
            showConfirm("Are you sure you want to clear ALL completed AI Recalls?", (confirmed) => {
                if (confirmed) {
                    logs.forEach(log => {
                        if (log.recallSchedule) {
                            log.recallSchedule = log.recallSchedule.filter(recall => recall.status !== 'completed');
                        }
                    });
                    saveToLocalStorage('beastieLogs', logs);
                    renderAIRecaller();
                    showMessage('Completed recalls cleared!', 'success');
                }
            });
        }


        // --- Gemini API Functions ---
        async function callGeminiAPI(prompt, outputElementId, loadingElementId) {
            const outputElement = document.getElementById(outputElementId);
            const loadingElement = document.getElementById(loadingElementId);

            outputElement.textContent = ''; // Clear previous output
            loadingElement.style.display = 'block'; // Show loading indicator

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyBUJ0pOE1GaT750wX4pWUWUpatcKZ6Bly4"; // Canvas will provide this at runtime if empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                console.log("Calling Gemini API with prompt:", prompt); // Debugging
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log("Gemini API raw response:", result); // Debugging
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    outputElement.textContent = text;
                    showMessage("AI response generated!", 'success');
                } else {
                    // Log the error details from the API response if available
                    const errorMessage = result.error && result.error.message ? result.error.message : "Unknown error from API.";
                    outputElement.textContent = `Error: Could not generate response. ${errorMessage}`;
                    console.error("Gemini API response structure unexpected or error:", result);
                    showMessage(`AI response failed: ${errorMessage}`, 'error');
                }
            } catch (error) {
                outputElement.textContent = "Error: Failed to connect to AI. Check your network or try again later.";
                console.error("Error calling Gemini API:", error);
                showMessage("AI response failed: Network or API error.", 'error');
            } finally {
                loadingElement.style.display = 'none'; // Hide loading indicator
            }
        }

        async function generateStudyPlan() {
            const subjects = document.getElementById('plannerSubjects').value.trim();
            const hours = document.getElementById('plannerHours').value.trim();
            const targetDate = document.getElementById('plannerTargetDate').value;

            if (!subjects || !hours || !targetDate) {
                showMessage("Please fill in all fields for the study plan.", 'error');
                return;
            }

            const today = new Date().toLocaleDateString();
            const prompt = `As an AI Study Coach, generate a detailed weekly study plan based on the following:
            Subjects: ${subjects}
            Total weekly study hours: ${hours}
            Target exam date: ${targetDate}
            Current date: ${today}

            The plan should be actionable, break down hours per subject, suggest topics (if general subjects like Math/Science), and include dedicated revision slots. Provide it in a clear, easy-to-read format.`;

            await callGeminiAPI(prompt, 'studyPlanOutput', 'studyPlanLoading');
        }

        async function explainConcept() {
            const concept = document.getElementById('conceptInput').value.trim();

            if (!concept) {
                showMessage("Please enter a concept to explain.", 'error');
                return;
            }

            const prompt = `Explain the concept of "${concept}" in a simple, concise, and easy-to-understand manner, as if explaining it to a high school student. Use analogies if helpful.`;

            await callGeminiAPI(prompt, 'conceptExplanationOutput', 'conceptLoading');
        }


        // --- Main Update Function ---
        function updateAll() {
            updateStreak();
            updateStats();
            updateGoal();
            drawCalendar();
            renderCharts(); // Re-render charts with updated data
            updateGamificationDisplay();
            renderTodos(); // Re-render to-do list
            filterLogs(); // Re-render filtered logs
            renderRevisionHub(); // Render revision hub
            renderAIRecaller(); // Render AI Recaller
        }

        // --- Password Lock ---
        function checkPassword() {
            console.log("checkPassword called.");
            const inp = document.getElementById("authPass").value;
            
            if (!inp) {
                showMessage("Please enter the password.", 'error');
                return;
            }

            if (inp === FIXED_PASSWORD) { // Check against the fixed password
                console.log("Password correct. Unlocking UI.");
                unlockUI();
            } else { // Incorrect password
                showMessage("‚ùå Incorrect password! Try again.", 'error');
                document.getElementById("authPass").value = ""; // Clear input
                console.log("Incorrect password.");
            }
        }

        function unlockUI() {
            console.log("unlockUI called.");
            const o = document.getElementById("authOverlay");
            const mainContent = document.getElementById('mainContent');

            o.style.opacity = '0'; // Start fade out animation
            o.style.transform = 'translateY(-40px)'; // Move up slightly while fading
            
            // Wait for the animation to complete for the overlay
            setTimeout(() => {
                console.log("Auth overlay fade-out complete. Hiding authOverlay.");
                o.style.visibility = 'hidden'; // Hide after fade
                o.style.display = 'none'; // Fully remove from layout
                if (o.parentNode) { // Safely remove element
                    o.parentNode.removeChild(o); 
                    console.log("Auth overlay removed from DOM.");
                }

                // Now, make main content visible and start its fade-in
                mainContent.style.display = 'flex'; // Make it flex BEFORE showing
                mainContent.style.opacity = '1';
                mainContent.style.visibility = 'visible';
                console.log("Main content visible. Loading initial data.");
                
                // Load initial data and render UI after main content is visible
                loadInitialData(); 
            }, 500); // Match this timeout to the fadeOut animation duration (0.5s)
        }

        // --- Initial Load Sequence ---
        function initialLoadSequence() {
            console.log("initialLoadSequence called.");
            const loadingOverlay = document.getElementById('loadingOverlay');
            const authOverlay = document.getElementById('authOverlay');
            const mainContent = document.getElementById('mainContent');

            // Ensure all are initially hidden by default, then control visibility
            loadingOverlay.style.display = 'flex'; // Show loading spinner
            loadingOverlay.style.opacity = '1';
            loadingOverlay.style.visibility = 'visible';
            console.log("Loading overlay shown.");

            authOverlay.style.display = 'none'; // Hide auth overlay initially
            mainContent.style.display = 'none'; // Hide main content initially

            // After a delay, fade out loading overlay and show password screen
            setTimeout(() => {
                loadingOverlay.style.opacity = '0'; // Start fade out
                console.log("Loading overlay starting fade-out.");
                setTimeout(() => {
                    loadingOverlay.style.visibility = 'hidden';
                    loadingOverlay.style.display = 'none'; // Fully hide
                    if (loadingOverlay.parentNode) {
                        loadingOverlay.parentNode.removeChild(loadingOverlay); // Remove from DOM
                        console.log("Loading overlay hidden and removed.");
                    }

                    // Show password overlay
                    authOverlay.style.display = 'flex'; // Make it flex BEFORE showing
                    authOverlay.classList.add('show'); // Trigger CSS transition for opacity/transform
                    console.log("Auth overlay shown.");
                }, 500); // Match loading overlay fade-out transition duration
            }, 2500); // Spinner display duration
        }

        // --- Data Loading and Initialization ---
        function loadInitialData() {
            console.log("loadInitialData called.");
            logs = loadFromLocalStorage('beastieLogs', []);
            // Ensure recallSchedule is initialized for all logs, even old ones
            logs.forEach(log => {
                if (!log.recallSchedule) {
                    log.recallSchedule = [];
                }
            });
            saveToLocalStorage('beastieLogs', logs); // Save to ensure new structure is persisted

            goal = loadFromLocalStorage('beastieGoal', 0);
            todos = loadFromLocalStorage('beastieTodos', []);
            userXP = loadFromLocalStorage('beastieXP', 0);
            userLevel = loadFromLocalStorage('beastieLevel', 1);
            
            // Load achievements and ensure all are present (for new ones added later)
            const savedAchievements = loadFromLocalStorage('beastieAchievements', []);
            achievements.forEach(defaultAch => {
                const saved = savedAchievements.find(sa => sa.id === defaultAch.id);
                if (saved) {
                    defaultAch.earned = saved.earned;
                }
            });
            saveToLocalStorage('beastieAchievements', achievements); // Save to ensure new structure is persisted

            pendingRevisions = loadFromLocalStorage('pendingRevisions', []);
            
            loadPomodoroSettings(); // Load Pomodoro settings

            // Call updateAll after all data is loaded
            updateAll(); 

            // Set initial tab to log study
            showTab('logStudySection');

            // Apply saved theme and accent color
            const savedTheme = localStorage.getItem('beastieTheme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                currentTheme = 'light';
            }
            const savedAccentColorName = localStorage.getItem('beastieAccentColor');
            if (savedAccentColorName && accentColors[savedAccentColorName]) {
                applyAccentColor(savedAccentColorName);
            } else {
                drawAccentColorPicker(); // Draw with default if none saved
            }
            console.log("Initial data loaded and UI updated.");
        }

        // --- Event Listeners for new features ---
        document.addEventListener('DOMContentLoaded', () => {
            // Pomodoro Controls
            document.getElementById('startTimer').addEventListener('click', startTimer);
            document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
            document.getElementById('resetTimer').addEventListener('click', resetTimer);
            document.getElementById('studyMins').addEventListener('change', resetTimer);
            document.getElementById('breakMins').addEventListener('change', resetTimer);

            // To-Do Input Enter Key
            document.getElementById('todoInput').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission if any
                    addTodo();
                }
            });
        });

        // --- On Page Load ---
        window.onload = initialLoadSequence; // THIS IS THE FIX!
        
    </script>
</body>
</html>
